function logError(a){console.log(a)}function Subscription(){this.callbackList=[]}function logError(a){console.log(a)}var SenseSearchInput=function(){function a(a,b){if("undefined"==typeof senseSearch&&b.senseSearch&&(senseSearch=b.senseSearch),"undefined"!=typeof document){var c=document.createElement("div");c.id=a,c.classList.add("sense-search-input-container");var d=i.replace(/{id}/gim,a);c.innerHTML=d}b=b||{};for(var e in b)this[e]=b[e];if(this.id=a,"undefined"!=typeof document){c.onkeyup=this.onKeyUp.bind(this),c.onkeydown=this.onKeyDown.bind(this),c.onclick=this.onClick.bind(this);var f=document.getElementById(a);if(f){f.attributes.mode&&c.setAttribute("data-mode",f.attributes.mode.value),f.insertAdjacentElement?f.insertAdjacentElement("afterEnd",c):f.insertAdjacentHTML("afterEnd",c.outerHTML);for(var g=0;g<f.attributes.length;g++)this[f.attributes[g].name]=f.attributes[g].value;f.parentNode.removeChild(f)}}return this.searchFields&&!Array.isArray(this.searchFields)&&this.searchFields.length&&(this.searchFields=this.searchFields.split(",")),this.suggestFields&&!Array.isArray(this.suggestFields)&&this.suggestFields.length&&(this.suggestFields=this.suggestFields.split(",")),this.searchTimeout=this.searchTimeout||300,this.suggestTimeout=this.suggestTimeout||100,this.chartTimeout=this.chartTimeout||300,this.ready=new Subscription,this.onAmbiguity=new Subscription,this.blockingTerms={},this.blockingTermKeys=[],senseSearch.ready.subscribe(this.activate.bind(this)),senseSearch.fieldsFetched.subscribe(this.fieldsFetched.bind(this)),senseSearch.onSelectionsApplied.subscribe(this.refresh.bind(this)),senseSearch.onLockedUnlocked.subscribe(this.refresh.bind(this)),senseSearch.cleared.subscribe(this.onClear.bind(this)),{element:c,object:this}}function b(a){return a.toLowerCase().replace(/ /gi,"_")}function c(a){return a.replace(/_/gi," ")}function d(a){var b=a.qText,c=a.qElemNumber;b=b.split("");var d;null!=a.qRanges[0]&&(d={qText:a.qText.substring(a.qRanges[0].qCharPos,a.qRanges[0].qCharPos+a.qRanges[0].qCharCount)});for(var e=a.qRanges.length-1;e>-1;e--)b.splice(a.qRanges[e].qCharPos+a.qRanges[e].qCharCount,0,"</span>"),b.splice(a.qRanges[e].qCharPos,0,"<span class='highlight"+a.qRanges[e].qTerm+"'>");return b=b.join("").replace(/<(?!\/?span(?=>|\s.*>))\/?.*?>/gim,""),{text:b,elem:c,matchValue:d}}function e(a,b){var c=a;if(-1!=b.toLowerCase().indexOf(c.toLowerCase()));else if(b.length>c.length)for(;-1==b.toLowerCase().indexOf(c.toLowerCase());)c=c.split(" "),c.splice(0,1),c=c.join(" ");for(;c.length>=b.length&&c.toLowerCase()!=b.toLowerCase();)c=c.split(" "),c.splice(0,1),c=c.join(" ");var d=new RegExp(c,"i");return b.replace(d,"")}var f=[16,27],g=[9,13,38,40,39,37,32,33,34],h={BACKSPACE:8,ESCAPE:27,CONTROL:17,COMMAND:91,PASTE:86,TAB:9,ENTER:13,SHIFT:16,UP:38,DOWN:40,RIGHT:39,LEFT:37,DELETE:46,SPACE:32},i="<div class='sense-search-input-main'><div id='{id}_ghost' class='sense-search-input-bg'></div><input id='{id}_input' autofocus placeholder='Please wait...' disabled='disabled' type='text' autocorrect='off' autocomplete='off' autocapitalize='off' spellcheck='false'/><div id='{id}_lozenges' class='sense-search-lozenge-container'></div><div id='{id}_ambiguities' class='sense-search-ambiguity-container'></div><button type='button' class='sense-search-input-clear'>x</button></div><div id='{id}_suggestions' class='sense-search-suggestion-container'><ul id='{id}_suggestionList'></ul></div><div id='{id}_associations' class='sense-search-association-container'><ul id='{id}_associationsList'></ul></div>";return a.prototype=Object.create(Object.prototype,{id:{writable:!0,value:null},MAX_SEARCH_TERMS:{writable:!0,value:10},ready:{writable:!0,value:null},onAmbiguity:{writable:!0,value:null},blockingTerms:{writable:!0},blockingTermKeys:{writable:!0},attach:{value:function(a){if(a)for(var b in a)this[b]=a[b];"visualizations"==this.mode?senseSearch.getAppFields(this.nlpModel.cardinalityLimit):this.activateInput(),senseSearch&&senseSearch.exchange.connection&&(senseSearch.searchAssociations.subscribe(this.onSearchAssociations.bind(this)),senseSearch.suggestResults.subscribe(this.onSuggestResults.bind(this)),senseSearch.inputs[this.id]||(senseSearch.inputs[this.id]=this))}},isCutCopyPaste:{writable:!0,value:!1},isPaste:{writable:!0,value:!1},searchText:{writable:!0,value:null},currentTerm:{writable:!0,value:null},searchFields:{writable:!0,value:[]},suggestFields:{writable:!0,value:[]},searchTimeout:{writable:!0,value:null},suggestTimeout:{writable:!0,value:null},chartTimeout:{writable:!0,value:null},searchTimeoutFn:{writable:!0,value:null},suggestTimeoutFn:{writable:!0,value:null},chartTimeoutFn:{writable:!0,value:null},suggesting:{writable:!0,value:!1},associating:{writable:!0,value:!1},suggestingTimeout:{writable:!0,value:3e3},suggestingTimeoutFn:{writable:!0,value:null},activeSuggestion:{writable:!0,value:0},ghostPart:{writable:!0,value:null},ghostQuery:{writable:!0,value:null},ghostDisplay:{writable:!0,value:null},cursorPosition:{writable:!0,value:0},allowNLP:{writable:!0,value:!1},nlpTerms:{writable:!0,value:[]},nlpSilentTerms:{writable:!0,value:{}},nlpResolvedTerms:{writable:!0,value:{}},nlpDistinctTerms:{writable:!0,value:{}},nlpTermsIndexes:{writable:!0,value:[]},nlpTermsPositions:{writable:!0,value:[]},nlpModel:{value:{fieldNounMap:{},fieldTagMap:{},functionMap:{avg:"avg",average:"avg",count:"count","how many":"count",sum:"sum",total:"sum","how much":"sum",min:"min",max:"max"},functionLabelMap:{sum:"Total",avg:"Average",count:"Count",min:"Minimum",max:"Maximum"},distinctMap:{distinct:"DISTINCT",unique:"DISTINCT"},negationMap:["not","ignore","ignoring","exclude","excluding","without"],defaultFunction:"sum",currencySymbol:"Â£",misc:["by","as","is","was","were","me","not","ignore","the","in","of","a","and","what","show"],comparatives:{more:">",less:"<",greater:">",above:">",below:"<",cheaper:"<"},conditionals:["where","for","is","from"],sorting:["order","ordered","sort","sorted"],sortorder:{asc:1,ascending:1,lowest:1,least:1,desc:-1,descending:-1,highest:-1,most:-1},vizTypeMap:{kpi:"kpi",barchart:"barchart","bar chart":"barchart",linechart:"linechart",piechart:"piechart",table:"table",treemap:"treemap",scatter:"scatterplot",boxplot:"boxplot",distributionplot:"distributionplot",histogram:"histogram"},cardinalityLimit:1e3}},fieldsFetched:{value:function(a){this.activateInput()}},lastSelectedGroup:{writable:!0,value:null},lastAssociationSummary:{writable:!0,value:null},lastSelectedAssociation:{writable:!0,value:null},appFields:{writable:!0,value:{}},appFieldsByTag:{writable:!0,value:{}},suggestions:{writable:!0,value:null},associations:{writable:!0,value:null},ambiguities:{writable:!0,value:[]},mode:{writable:!0,value:"associations"},addFieldNoun:{value:function(a,b){this.nlpModel.fieldNounMap[a]||(this.nlpModel.fieldNounMap[a]=[]),-1===this.nlpModel.fieldNounMap[a].indexOf(b)&&this.nlpModel.fieldNounMap[a].push(b)}},addFieldTag:{value:function(a,c){var d=b(a);if(this.nlpModel.fieldTagMap[d]||(this.nlpModel.fieldTagMap[d]=[]),"object"==typeof c&&c.length)for(var e=0;e<c.length;e++)-1===this.nlpModel.fieldTagMap[d].indexOf(c[e])&&this.nlpModel.fieldTagMap[d].push(c[e]);else-1===this.nlpModel.fieldTagMap[d].indexOf(c)&&this.nlpModel.fieldTagMap[d].push(c)}},onClear:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_input");a&&(a.value="")}this.searchText="",this.nlpTerms=[],this.nlpResolvedTerms={},this.nlpTermsPositions=[],this.currentTerm=null,this.lastSelectedGroup=null,this.hideSuggestions(),this.hideAssociations(),this.clearLozenges()}},onSearchResults:{value:function(){}},onSearchAssociations:{value:function(a){if(this.associations=a.qResults,"associations"==this.mode)this.showAssociations();else{console.log("ambiguities");var c=this.getTermByText(this.associations.qSearchTerms[this.associations.qSearchTerms.length-1]),d=this.getTermIndexByText(this.associations.qSearchTerms[this.associations.qSearchTerms.length-1]);if(!c||0===c.length)return void(0==this.blockingTermKeys.length&&this.nlpViz());delete this.blockingTerms[c[0].parsedText],this.blockingTermKeys=Object.keys(this.blockingTerms);for(var e=0;e<c.length;e++)if(0==this.associations.qFieldNames.length)c[e].queryTag="!!",this.buildLozenges(),0==this.blockingTermKeys.length&&this.nlpViz();else if(1==this.associations.qFieldNames.length){c[e].queryTag=this.associations.qFieldNames[0],c[e].senseTag="value",c[e].senseType="value",c[e].senseInfo={field:senseSearch.appFields[b(this.associations.qFieldNames[0])],fieldSelection:"="};var f=d[e];this.nlpTerms[f-1]&&this.nlpTerms[f-1].text&&-1!==this.nlpModel.negationMap.indexOf(this.nlpTerms[f-1].text.toLowerCase())&&(c[e].senseInfo.fieldSelection="-="),this.buildLozenges(),0==this.blockingTermKeys.length&&this.nlpViz()}else c[e].senseType="?",c[e].extra={fields:this.associations.qFieldNames},this.buildLozenges(),this.addAmbiguity(c[e].name,{termIndex:d[e],term:c[e],fields:this.associations.qFieldNames})}}},onSuggestResults:{value:function(a){this.suggestions=a.qSuggestions,this.suggestions.splice(5,a.qSuggestions.length-4),this.suggestions.length>0&&(this.activeSuggestion=0),this.showSuggestions()}},getTerm:{value:function(a){return this.nlpTerms[a.replace(/ /gi,"_")]}},setCurrentTerm:{value:function(a){this.currentTerm=a[this.getCurrentTermIndex()]}},getTermByText:{value:function(a){for(var b=[],c=0;c<this.nlpTerms.length;c++)this.nlpTerms[c].text!=a||this.nlpTerms[c].senseType&&""!=this.nlpTerms[c].senseType||b.push(this.nlpTerms[c]);return b}},getTermIndexByText:{value:function(a){for(var b=[],c=0;c<this.nlpTerms.length;c++)this.nlpTerms[c].text!=a||this.nlpTerms[c].senseType&&""!=this.nlpTerms[c].senseType||b.push(c);return b}},getCurrentTermIndex:{value:function(){return this.nlpTermsPositions[this.cursorPosition-1]}},processTerms:{value:function(a,d){a=a.toLowerCase();var e=a,f=[];for(var g in senseSearch.appFields){var h,i;senseSearch.appFields[g].qInfo?(h=senseSearch.appFields[g].qData.title,i="measure"===senseSearch.appFields[g].qInfo.qType?"exp":"dim"):(h=senseSearch.appFields[g].qName,i=senseSearch.appFieldsByTag.$measure&&senseSearch.appFieldsByTag.$measure[g]?"exp":this.nlpModel.fieldTagMap[g]&&-1!==this.nlpModel.fieldTagMap[g].indexOf("$measure")?"exp":"dim");var j=b(h),k=c(j),l=a.indexOf(k),m=-1;if(-1==l&&this.nlpModel.fieldNounMap[k])for(var n=0;n<this.nlpModel.fieldNounMap[k].length;n++)if(-1!==a.indexOf(this.nlpModel.fieldNounMap[k][n].toLowerCase())){m=a.indexOf(this.nlpModel.fieldNounMap[k][n].toLowerCase()),h=this.nlpModel.fieldNounMap[k][n],k=this.nlpModel.fieldNounMap[k][n].toLowerCase();break}if(-1!==l||-1!==m){var o=-1===l?m:l;if(o>0&&" "!==a.split("")[o-1])continue;if(a.split("")[o+k.length]&&" "!==a.split("")[o+k.length])continue;e=e.replace(k,";||"+k+";");var p={name:g,text:h,parsedText:k,position:o,length:h.length,senseType:i,queryTag:i,senseInfo:{field:senseSearch.appFields[g]}};senseSearch.appFieldsByTag.$time&&senseSearch.appFieldsByTag.$time[g]?p.senseInfo.type="time":senseSearch.appFieldsByTag.$timestamp&&senseSearch.appFieldsByTag.$timestamp[g]?p.senseInfo.type="time":this.nlpModel.fieldTagMap[b(h)]&&-1!==this.nlpModel.fieldTagMap[b(h)].indexOf("$time")&&(p.senseInfo.type="time"),f.push(p)}}for(var q=e.split(";"),r=[],s=0;s<q.length;s++){var t=0;if(t=0==s?0:r[s-1]+q[s-1].replace("||","").length,r.push(t),-1==q[s].indexOf("||")&&q[s].length>0)for(var u=q[s].split(" "),v=0,w=0;w<u.length;w++)0==w&&" "==q[s].split()[0]?v=1:v++,u[w].length>0&&f.push({name:u[w],text:u[w],parsedText:u[w],position:t+v,length:u[w].length}),v+=u[w].length}f.sort(function(a,b){return a.position<b.position?-1:a.position>b.position?1:0}),this.createTermPosArray(f),this.nlpTerms=[];for(var x=0;x<f.length;x++)if(this.nlpResolvedTerms[f[x].name])this.nlpTerms.push(this.nlpResolvedTerms[f[x].name]);else{var y=this.tagTerm(f[x]);y.queryTag||console.log("no tag"),this.nlpTerms.push(y)}for(var x=0;x<this.nlpTerms.length;x++)this.nlpTerms[x]&&this.nlpTerms[x+1]&&(this.nlpTerms[x].queryTag||this.nlpTerms[x+1].queryTag||(this.joinTerms(x,x+1),x--));console.log(this.nlpTerms)}},createTermPosArray:{value:function(a){this.nlpTermsPositions=[];for(var b=0;b<a.length;b++){for(var c=a[b].text.split(""),d=0;d<c.length;d++)this.nlpTermsPositions.push(b);b<a.length-1?this.nlpTermsPositions.push(-1):b==a.length-1&&" "==this.searchText.split("").pop&&this.nlpTermsPositions.push(-1)}}},joinTerms:{value:function(a,c){this.nlpTerms[a].length+=this.nlpTerms[c].length+1,this.nlpTerms[a].text+=" "+this.nlpTerms[c].text,this.nlpTerms[a].name=b(this.nlpTerms[a].text),this.nlpTerms[a].parsedText=this.nlpTerms[a].name,this.nlpTerms.splice(c,1)}},tagTerm:{value:function(a){var b=a.text.toLowerCase(),c=this.getCurrentTermIndex();return a.queryTag||(this.nlpModel.functionMap[b]?(a.senseType="function",a.senseInfo={func:this.nlpModel.functionMap[b]},a.queryTag="function"):-1!=this.nlpModel.sorting.indexOf(b)?a.queryTag="sorting":this.nlpModel.sortorder[b]?(a.queryTag="sortorder",this.nlpTerms[c-1]&&"sort by"===this.nlpTerms[c-1].queryTag?this.nlpTerms[c-1].senseInfo.order=this.nlpModel.sortorder[b]:(a.senseType="sortorder",a.senseInfo={order:this.nlpModel.sortorder[b]})):this.nlpModel.vizTypeMap[b]?(a.queryTag="viz",a.senseType="viz",a.senseInfo={viz:this.nlpModel.vizTypeMap[b]}):this.nlpModel.distinctMap[b]?a.queryTag="distinct":this.nlpModel.comparatives[b]?a.queryTag="!":-1!=this.nlpModel.conditionals.indexOf(b)?a.queryTag="!":-1!=this.nlpModel.misc.indexOf(b)&&(a.queryTag="!")),a}},clear:{value:function(){senseSearch.clear()}},onClick:{value:function(a){if(a.target.classList.contains("sense-search-input-clear"))this.clear();else if(a.target.classList.contains("sense-search-suggestion-item"))this.activeSuggestion=parseInt(a.target.attributes["data-index"].value),this.drawGhost(),this.acceptSuggestion();else if(a.target.classList.contains("sense-search-association-item")||a.target.parentNode.classList.contains("sense-search-association-item")||a.target.parentNode.parentNode.classList.contains("sense-search-association-item")){var b;b=a.target.classList.contains("sense-search-association-item")?parseInt(a.target.attributes["data-index"].value):a.target.parentNode.classList.contains("sense-search-association-item")?parseInt(a.target.parentNode.attributes["data-index"].value):parseInt(a.target.parentNode.parentNode.attributes["data-index"].value),this.lastSelectedGroup=b,this.lastAssociationSummary&&this.lastAssociationSummary.length>0&&(this.lastSelectedAssociation=this.lastAssociationSummary[b]),senseSearch.selectAssociations(this.searchFields||[],b),this.hideAssociations(),this.hideSuggestions()}else if(a.target.classList.contains("ambiguity")){var c=a.target.attributes["data-term"].value;this.showAmbiguityOptions(c)}else if(a.target.classList.contains("ambiguous_resolve")){var c=a.target.attributes["data-term"].value,d=a.target.innerText;this.resolveAmbiguity(c,d)}}},onKeyDown:{value:function(a){if(a.keyCode==h.ESCAPE)return void this.hideSuggestions();if(a.keyCode==h.CONTROL||a.keyCode==h.COMMAND)return void(this.isCutCopyPaste=!0);if(a.keyCode==h.PASTE&&this.isCutCopyPaste)return void(this.isPaste=!0);if(a.keyCode==h.DOWN)this.showSuggestions();else if(a.keyCode==h.RIGHT)this.suggesting&&(a.preventDefault(),this.nextSuggestion());else if(a.keyCode==h.LEFT)this.suggesting&&(a.preventDefault(),this.prevSuggestion());else if(a.keyCode==h.ENTER||a.keyCode==h.TAB)this.suggesting?(a.preventDefault(),this.acceptSuggestion()):this.associating&&a.keyCode==h.ENTER&&(a.preventDefault(),senseSearch.selectAssociations(this.searchFields||[],0),this.hideAssociations());else if(a.keyCode==h.SPACE){if(this.searchText.split(" ").length==this.MAX_SEARCH_TERMS)return alert("Too many search terms"),a.preventDefault(),!1;if(1==this.searchText.split(" ").pop().length&&"visualizations"!==this.mode)return alert("cannot search for single character strings"),a.preventDefault(),!1;this.hideSuggestions(),this.hideAssociations()}else this.hideSuggestions(),this.hideAssociations()}},onKeyUp:{value:function(a){a.keyCode==h.Control&&(this.isCutCopyPaste=!1);var b=document.getElementById(this.id+"_input");b&&(this.searchText=b.value,this.cursorPosition=a.target.selectionStart,"visualizations"===this.mode&&(this.processTerms(this.searchText,!this.isPaste),this.buildLozenges(),this.isPaste=!1),-1==f.indexOf(a.keyCode)&&-1==g.indexOf(a.keyCode)&&("visualizations"===this.mode?this.preVizSearch():this.preSearch()))}},preSearch:{value:function(){if(this.searchText&&this.searchText.length>0){if(this.searchText.split(" ").pop().length>1){var a=this;this.searchTimeoutFn&&clearTimeout(this.searchTimeoutFn),this.searchTimeoutFn=setTimeout(function(){a.search()},this.searchTimeout),this.searchText.length>1&&this.cursorPosition==this.searchText.length&&(this.suggestTimeoutFn&&clearTimeout(this.suggestTimeoutFn),this.suggestTimeoutFn=setTimeout(function(){a.suggest()},this.suggestTimeout))}}else this.clear()}},preVizSearch:{value:function(){var a=!1;if(this.searchText&&this.searchText.trim().length>1){var b=this;this.searchTimeoutFn&&clearTimeout(this.searchTimeoutFn),this.searchTimeoutFn=setTimeout(function(){for(var c=0;c<b.nlpTerms.length;c++)b.nlpTerms[c].senseType||b.nlpTerms[c].queryTag||(a=!0,b.searchForSingleTerm(b.nlpTerms[c].text))},this.searchTimeout),this.chartTimeoutFn&&clearTimeout(this.chartTimeoutFn),this.chartTimeoutFn=setTimeout(function(){this.blockingTermKeys&&0!=this.blockingTermKeys.length||a||b.nlpViz()},this.chartTimeout)}this.searchText&&0!=this.searchText.length||this.clear()}},replaceSearchText:{value:function(a,b,c){var d=this.searchText+" ";return-1===d.indexOf(a)?!1:(d=d.replace(parts[0],parts[1]),void this.setSearchText(d,c))}},setSearchText:{value:function(a,b){if(b=b||!1,this.searchText=a,this.isPaste=!0,this.cursorPosition=a.length,"undefined"!=typeof document){var c=document.getElementById(this.id+"_input");c&&(c.value=a)}"visualizations"!==this.mode||b?b||this.preSearch():(this.processTerms(this.searchText,!this.isPaste),this.buildLozenges(),this.preVizSearch()),this.isPaste=!1}},refresh:{value:function(){this.setSearchText(this.searchText)}},showSuggestions:{value:function(){if(this.startSuggestionTimeout(),this.searchText&&this.searchText.length>1&&this.cursorPosition==this.searchText.length&&this.suggestions.length>0){if(this.suggesting=!0,this.drawGhost(),"undefined"!=typeof document){var a=document.getElementById(this.id+"_suggestions");a&&(a.style.display="block")}this.drawSuggestions()}else this.suggesting=!1,this.removeGhost(),this.hideSuggestions()}},hideSuggestions:{value:function(){if(this.suggesting=!1,this.activeSuggestion=0,this.ghostPart="",this.ghostQuery="",this.ghostDisplay="",this.removeGhost(),"undefined"!=typeof document){var a=document.getElementById(this.id+"_suggestions");a&&(a.style.display="none")}}},showAssociations:{value:function(){var a="";this.associating=!0,this.lastAssociationSummary=[];for(var b=0;b<this.associations.qSearchTermsMatched.length;b++)for(var c=this.associations.qSearchTermsMatched[b],e=0;e<c.length;e++){a+="<li class='sense-search-association-item' data-index='"+e+"'>";for(var f=[],g=0;g<c[e].qFieldMatches.length;g++){var h="";c[e].qFieldMatches.length>1&&(h="width: "+Math.floor(100/c[e].qFieldMatches.length)+"%;");var i=c[e].qFieldMatches[g],j=this.associations.qFieldNames[i.qField],k=[],l=[],m=[];for(var n in i.qValues){var o=d(this.associations.qFieldDictionaries[i.qField].qResult[n],i.qTerms);l.push(o.matchValue),k.push(o.text),m.push(o.elem)}a+="<div style='"+h+"'>",a+="<h1>"+j+"</h1>";for(var n=0;n<k.length;n++)a+=k[n],n<k.length-1&&(a+=", ");a+="</div>",f.push({field:j,values:l,elems:m})}a+="</li>",this.lastAssociationSummary.push(f)}if("undefined"!=typeof document){var p=document.getElementById(this.id+"_associationsList");p&&(p.innerHTML=a);var q=document.getElementById(this.id+"_associations");q&&(q.style.display="block")}}},hideAssociations:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_associations");a&&(a.style.display="none"),this.associating=!1}}},addAmbiguity:{value:function(a,b){this.ambiguities[a]=b,this.onAmbiguity.deliver(b)}},showAmbiguityOptions:{value:function(a){if("undefined"!=typeof document){var b=document.getElementById("ambiguous_"+a);b&&(b.style.display="initial")}}},resolveAmbiguity:{value:function(a,c){"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch),this.nlpTerms[a].senseType="value",this.nlpTerms[a].queryTag=c,this.nlpTerms[a].senseInfo={field:senseSearch.appFields[b(c)],fieldSelection:"="},this.nlpTerms[a-1]&&this.nlpTerms[a-1].text&&"not"===this.nlpTerms[a-1].text.toLowerCase()&&(this.nlpTerms[a].senseInfo.fieldSelection="-="),this.nlpResolvedTerms[this.nlpTerms[a].name]=this.nlpTerms[a],this.buildLozenges(),this.nlpViz(),delete this.ambiguities[this.nlpTerms[a].name]}},buildLozenges:{value:function(){var a="",b="";for(var c in this.nlpTerms){if(a+="<div class='lozenge' ",this.nlpTerms[c].queryTag&&""!==this.nlpTerms[c].queryTag&&(a+=" data-querytag='"+this.nlpTerms[c].queryTag+"'"),this.nlpTerms[c].senseType&&""!==this.nlpTerms[c].senseType&&(a+=" data-sensetag='"+this.nlpTerms[c].senseType+"'"),a+=">",a+=this.nlpTerms[c].parsedText,a+="</div>",b+="<div class='ambiguity-provision' data-querytag='"+this.nlpTerms[c].queryTag+"'>",b+=this.nlpTerms[c].parsedText,"?"==this.nlpTerms[c].senseType){b+="<div class='ambiguity' data-term='"+c+"'>?</div>",b+="<ul id='ambiguous_"+c.replace(/ /gi,"_")+"' style='display: none;'>";for(var d=0;d<this.nlpTerms[c].extra.fields.length;d++)b+="<li class='ambiguous_resolve' data-term='"+c+"'>",b+=this.nlpTerms[c].extra.fields[d],b+="</li>"}b+="</ul>",b+="</div>"}if("undefined"!=typeof document){var e=document.getElementById(this.id+"_lozenges");e&&(e.innerHTML=a);var f=document.getElementById(this.id+"_ambiguities");f&&(f.innerHTML=b)}}},clearLozenges:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_lozenges");a&&(a.innerHTML="");var b=document.getElementById(this.id+"_ambiguities");b&&(b.innerHTML="")}}},startSuggestionTimeout:{value:function(){this.suggestingTimeoutFn&&clearTimeout(this.suggestingTimeoutFn),this.suggestingTimeoutFn=setTimeout(function(){"associations"!==this.mode&&this.hideSuggestions.call(this)}.bind(this),this.suggestingTimeout)}},nextSuggestion:{value:function(){this.startSuggestionTimeout(),this.activeSuggestion==this.suggestions.length-1?this.activeSuggestion=0:this.activeSuggestion++,this.drawGhost(),this.highlightActiveSuggestion()}},prevSuggestion:{value:function(){this.startSuggestionTimeout(),0==this.activeSuggestion?this.activeSuggestion=this.suggestions.length-1:this.activeSuggestion--,this.drawGhost(),this.highlightActiveSuggestion()}},acceptSuggestion:{value:function(){if(this.searchText=this.ghostQuery,this.suggestions=[],this.hideSuggestions(),"undefined"!=typeof document){var a=document.getElementById(this.id+"_input");a&&(a.value=this.searchText)}this.search()}},search:{value:function(){"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch),senseSearch.search(this.searchText,this.searchFields||[],this.mode)}},searchForSingleTerm:{value:function(a){"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch),this.blockingTerms[a]=!0,this.blockingTermKeys=Object.keys(this.blockingTerms),console.log("blocking: "+a),senseSearch.search(a,this.searchFields||[],this.mode)}},suggest:{value:function(){"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch),senseSearch.suggest(this.searchText,this.suggestFields||[])}},nlpViz:{value:function(){console.trace(),"undefined"==typeof senseSearch&&this.senseSearch&&(senseSearch=this.senseSearch),console.log("creating viz");var a,c={qInfo:{},qHyperCubeDef:{qDimensions:[],qMeasures:[],qInitialDataFetch:[{qTop:0,qLeft:0,qHeight:1e3,qWidth:10}]}},d={},e={},f=[],g={},h={},i=0,j=[],k=null,l=null,m={},n={},o=0,p=0;this.nlpSilentTerms||(this.nlpSilentTerms={}),this.nlpSilentTerms&&this.nlpSilentTerms.viz&&(a=this.nlpModel.vizTypeMap[this.nlpSilentTerms.viz]);for(var q=0;q<this.nlpTerms.length;q++)"exp"==this.nlpTerms[q].senseType&&p++,"dim"==this.nlpTerms[q].senseType&&(this.nlpTerms[q-1]?this.nlpModel.distinctMap[this.nlpTerms[q-1].text]?(this.nlpTerms[q].senseType="exp",this.nlpTerms[q].senseInfo.countDistinct=!0,this.nlpTerms[q].senseInfo.func="count",p++):"function"==this.nlpTerms[q-1].senseType&&(this.nlpTerms[q].senseType="exp",this.nlpTerms[q].senseInfo.func=this.nlpTerms[q-1].senseInfo.func,p++):this.nlpTerms[q+1]&&"function"==this.nlpTerms[q+1].senseType&&(this.nlpTerms[q].senseType="exp",this.nlpTerms[q].senseInfo.func=this.nlpTerms[q+1].senseInfo.func,p++));for(var q=0;q<this.nlpTerms.length;q++)"viz"==this.nlpTerms[q].senseType&&(a=this.nlpTerms[q].senseInfo.viz);if(0==p)for(var q=0;q<this.nlpTerms.length;q++)0==p&&"dim"==this.nlpTerms[q].senseType&&"histogram"!=a&&(senseSearch.appFieldsByTag.$possibleMeasure&&senseSearch.appFieldsByTag.$possibleMeasure[this.nlpTerms[q].parsedText]?(this.nlpTerms[q].senseType="exp",p++,senseSearch.appFieldsByTag.$numeric&&senseSearch.appFieldsByTag.$numeric[this.nlpTerms[q].parsedText]?this.nlpTerms[q].senseInfo.func=this.nlpModel.defaultFunction:this.nlpTerms[q].senseInfo.func="count"):(this.nlpTerms[q].senseType="exp",this.nlpTerms[q].senseInfo.countDistinct=!0,this.nlpTerms[q].senseInfo.func="count"));o=-1,p=-1;for(var q=0;q<this.nlpTerms.length;q++)switch(this.nlpTerms[q].senseType){case"exp":var r=this.nlpTerms[q],s=r.name,t="";s=r.senseInfo.field.qInfo?r.senseInfo.field.qData.title.replace(/ /gi,"-"):this.nlpTerms[q].senseInfo.field.qName.replace(/ /gi,"-"),e[s]={field:this.nlpTerms[q].senseInfo.field},this.nlpTerms[q].senseInfo.countDistinct&&(e[s].isCountDistinct=!0,t+="Distinct "),this.nlpTerms[q].senseInfo.func?(e[s].func=this.nlpTerms[q].senseInfo.func,t+=this.nlpModel.functionLabelMap[this.nlpTerms[q].senseInfo.func]+("count"==this.nlpTerms[q].senseInfo.func?" of ":" ")):t+="<<func>> ",t+=this.nlpTerms[q].senseInfo.field.qName,e[s].label=t,p++,n[s]=p;break;case"dim":var u=this.nlpTerms[q],v=this.nlpTerms[q].name;u.senseInfo.field.qInfo?d[v]={qLibraryId:u.senseInfo.field.qInfo.qId}:(v=this.nlpTerms[q].senseInfo.field.qName.replace(/ /gi,"-"),d[v]=this.nlpTerms[q].senseInfo.field,"time"==this.nlpTerms[q].senseInfo.type&&j.push(v)),o++,m[v]=o;break;case"function":k=this.nlpTerms[q].senseInfo.func;break;case"value":var w,x;this.nlpTerms[q].senseInfo.field&&this.nlpTerms[q].senseInfo.field.qInfo?(x=b(this.nlpTerms[q].senseInfo.field.qData.title),w=this.nlpTerms[q].senseInfo.field.qData.title):(x=b(this.nlpTerms[q].senseInfo.field.qName),w=this.nlpTerms[q].senseInfo.field.qName),h[x]||(h[x]={field:w,selector:this.nlpTerms[q].senseInfo.fieldSelection,values:[]});var y="";y+="'",y+=this.nlpTerms[q].text,y+="*'",h[x].values.push(y),i++;break;case"sortfield":var z=this.nlpTerms[q].senseInfo.field.qName.replace(/ /gi,"-");g[z]=this.nlpTerms[q].senseInfo;break;case"sortorder":l=this.nlpTerms[q].senseInfo.order;break;case"viz":a=this.nlpModel.vizTypeMap[this.nlpTerms[q].senseInfo.viz]}for(var A in d){var B={};if(B=d[A].qLibraryId?d[A]:{qDef:{qFieldDefs:[d[A].qName]},qNullSuppression:!0},g[A]){var C="qSortByAscii",D=g[A].order||1;senseSearch.appFieldsByTag.$numeric&&-1!=senseSearch.appFieldsByTag.$numeric.indexOf(A)&&(C="qSortByNumeric"),B.qDef.qSortCriterias=[{}],B.qDef.qSortCriterias[0][C]=D}c.qHyperCubeDef.qDimensions.push(B),f.push(d[A].qName)}for(var E in e){var F={};if(e[E].qLibraryId)F.qDef=e[E];else{var G="=num(",H=e[E].func||k||this.nlpModel.defaultFunction;if(e[E].label=e[E].label.replace(/\<\<func\>\>/gim,this.nlpModel.functionLabelMap[H]),-1!==e[E].label.toLowerCase().indexOf("count")&&-1===e[E].label.toLowerCase().indexOf("count of")&&(e[E].label=e[E].label.replace(/count/i,"Count of ")),G+=H,G+="(",e[E].isCountDistinct&&(G+="DISTINCT "),G+="{$",i>0){G+="<",setLabelsCount=0;var I=[];for(var J in h){var K="";0==setLabelsCount&&"-="!=h[J].selector?e[E].label+=" for ":"-="==h[J].selector&&(e[E].label+=" excluding "),e[E].label+=h[J].values.join(", "),K+="["+h[J].field+"]",K+=h[J].selector,K+="{",K+=h[J].values.join(","),K+="}",I.push(K)}G+=I.join(","),G+=">"}G+="}",G+=e[E].field.qInfo?"["+e[E].field.qData.title+"]":"["+e[E].field.qName+"]",G+="), '";var L=b(e[E].field.qName);senseSearch.appFieldsByTag.$currency&&senseSearch.appFieldsByTag.$currency[E]&&"count"!==k?G+=this.nlpModel.currencySymbol:this.nlpModel.fieldTagMap[L]&&-1!==this.nlpModel.fieldTagMap[L].indexOf("$currency")&&"count"!==k&&(G+=this.nlpModel.currencySymbol),G+="#,##0')";var F={qDef:{qDef:G,qLabel:e[E].label,sortLabel:e[E].field.qName}};if(f.push(e[E].field.qName),g[E]){var C="qSortByNumeric",D=g[E].order||1;F.qSortBy={},F.qSortBy[C]=D,c.qHyperCubeDef.qInterColumnSortOrder=[f.indexOf(e[E].field.qName)]}}c.qHyperCubeDef.qMeasures.push(F)}var M=0;for(var J in g)M++;if(0==M&&c.qHyperCubeDef.qDimensions&&c.qHyperCubeDef.qDimensions.length>0)if(j.length>0){var N=m[j[0]];c.qHyperCubeDef.qDimensions[N].qDef.qSortCriterias=[{qSortByNumeric:l||1}],c.qHyperCubeDef.qInterColumnSortOrder=[0]}else c.qHyperCubeDef.qMeasures.length>0?(c.qHyperCubeDef.qMeasures[0].qSortBy={qSortByNumeric:l||-1},c.qHyperCubeDef.qInterColumnSortOrder=[f.indexOf(c.qHyperCubeDef.qMeasures[0].qDef.sortLabel)]):c.qHyperCubeDef.qDimensions.length>0;var O=c.qHyperCubeDef.qDimensions.length+c.qHyperCubeDef.qMeasures.length;a||(a=1==O?this.nlpModel.vizTypeMap.kpi:c.qHyperCubeDef.qMeasures.length>0?j.length>0?this.nlpModel.vizTypeMap.linechart:this.nlpModel.vizTypeMap.barchart:this.nlpModel.vizTypeMap.table),c.qInfo.qType=this.nlpModel.vizTypeMap[a]||a,"table"==c.qInfo.qType,(c.qHyperCubeDef.qDimensions.length>0||c.qHyperCubeDef.qMeasures.length>0)&&senseSearch.createViz(c)}},drawGhost:{value:function(){if(this.ghostPart=e(this.searchText,this.suggestions[this.activeSuggestion].qValue),this.ghostQuery=this.searchText+this.ghostPart,"undefined"!=typeof document){var a="<span style='color: transparent;'>"+this.searchText+"</span>"+this.ghostPart,b=document.getElementById(this.id+"_ghost");b&&(b.innerHTML=a)}}},removeGhost:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_ghost");a&&(a.innerHTML="")}}},drawSuggestions:{value:function(){for(var a="",b=0;b<this.suggestions.length;b++)a+="<li id='"+this.id+"_suggestion_"+b+"' class='sense-search-suggestion-item' data-index='"+b+"'>",a+=this.suggestions[b].qValue,a+="</li>";if("undefined"!=typeof document){var c=document.getElementById(this.id+"_suggestionList");c&&(c.innerHTML=a)}this.highlightActiveSuggestion()}},highlightActiveSuggestion:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_suggestionList");if(a)for(var b=0;b<a.childElementCount;b++)a.childNodes[b].classList.remove("active");var c=document.getElementById(this.id+"_suggestion_"+this.activeSuggestion);c&&c.classList.add("active")}}},activate:{value:function(){this.attach()}},activateInput:{value:function(){if("undefined"!=typeof document){var a=document.getElementById(this.id+"_input");a&&(a.attributes.placeholder.value=this.placeholder||"Enter up to "+this.MAX_SEARCH_TERMS+" search terms",a.disabled=!1,console.log("input activated"),this.ready.deliver())}}}}),a}(),SenseSearchResult=function(){function a(a,b){var c=document.createElement("div");c.id=a,c.classList.add("sense-search-results-container"),this.resultsElement=a+"_results",this.loadingElement=a+"_results_loading";var e=d.replace(/{id}/gim,a);c.innerHTML=e,b=b||{};for(var f in b)this[f]=b[f];this.id=a;var g=document.getElementById(a);if(g){g.insertAdjacentElement?g.insertAdjacentElement("afterEnd",c):g.insertAdjacentHTML("afterEnd",c.outerHTML);for(var h=0;h<g.attributes.length;h++)this[g.attributes[h].name]=g.attributes[h].value;g.parentNode.removeChild(g)}return senseSearch.ready.subscribe(this.activate.bind(this)),
{element:c,object:this}}function b(a,b){for(var c=[],d=0;d<a.length;d++)if(a[d].dimension){var e={qDef:{qFieldDefs:[a[d].dimension]},qNullSuppression:a[d].suppressNull};if(b[a[d].dimension]){var f={};if("array"==typeof b[a[d].dimension].sortType)for(var g=0;g<b[a[d].dimension].sortType.length;g++)f[b[a[d].dimension].sortType[g]]=b[a[d].dimension].order[g];else f[b[a[d].dimension].sortType]=b[a[d].dimension].order;b[a[d].dimension].sortExpression&&(f.qExpression=b[a[d].dimension].sortExpression),e.qDef.qSortCriterias=[f]}c.push(e)}return c}function c(a){for(var b=[],c=0;c<a.length;c++)if(a[c].measure){var d={qDef:{qLabel:a[c].label,qDescription:"",qDef:a[c].measure}};if(a[c].sortType)if(d.qSortBy={},"array"==typeof a[c].sortType)for(var e=0;e<a[c].sortType.length;e++)d.qSortBy[a[c].sortType[e]]=a[c].order[e];else d.qSortBy[a[c].sortType]=a[c].order;b.push(d)}return b}var d="<div id='{id}_results_loading' class='sense-search-results_loading on'><div class='sense-search-results_loading-spinner'>Loading...</div></div><div id='{id}_results' class='sense-search-results'></div>";return a.prototype=Object.create(Object.prototype,{id:{writable:!0,value:!1},handle:{writable:!0,value:!1},activate:{value:function(){this.attach()}},attached:{writable:!0,value:!1},attach:{value:function(a,b){var c=this;if(a)for(var d in a)this[d]=a[d];if(this.currentSort=this.defaultSort,senseSearch&&senseSearch.exchange.connection){if(a&&a.fields){var e=this.buildHyperCubeDef();"CapabilityAPI"==senseSearch.exchange.connectionType?senseSearch.exchange.app.createCube(e.qHyperCubeDef,this.onSearchResults.bind(this)).then(function(a){console.log(a),c.handle=a.handle,"function"==typeof b&&b.call(null)},logError):senseSearch.exchange.ask(senseSearch.appHandle,"CreateSessionObject",[e],function(a){c.handle=a.result.qReturn.qHandle,"function"==typeof b&&b.call(null)})}this.attached||(senseSearch.searchStarted.subscribe(this.onSearchStarted.bind(this)),senseSearch.searchResults.subscribe(this.onSearchResults.bind(this)),senseSearch.noResults.subscribe(this.onNoResults.bind(this)),senseSearch.chartResults.subscribe(this.onChartResults.bind(this)),senseSearch.cleared.subscribe(this.onClear.bind(this)),this.attached=!0),senseSearch.results[this.id]=this}this.hideLoading()}},fields:{writable:!0,value:[]},data:{writable:!0,value:[]},sortOptions:{writable:!0,value:{}},defaultSort:{writable:!0,value:null},currentSort:{writable:!0,value:null},enableHighlighting:{writable:!0,value:!0},pageTop:{writable:!0,value:0},pageSize:{writable:!0,value:20},pagesLoaded:{writable:!0,value:[]},buildHyperCubeDef:{value:function(){var a={qInfo:{qType:"table"},qHyperCubeDef:{qDimensions:b(this.fields,this.sortOptions),qMeasures:c(this.fields),qSuppressZero:!1,qSuppressMissing:!1,qInterColumnSortOrder:this.getInterColumnSortOrder(this.getFieldIndex(this.defaultSort).index)}};return a}},resultsElement:{writable:!0,value:null},latestLayout:{writable:!0,value:null},showLoading:{value:function(){var a=document.getElementById(this.loadingElement);a&&a.classList.add("on")}},hideLoading:{value:function(){var a=document.getElementById(this.loadingElement);a&&a.classList.remove("on")}},onSearchStarted:{value:function(){this.showLoading()}},onSearchResults:{value:function(a){this.hideLoading(),this.data=[],this.pageTop=0,this.pagesLoaded=[],this.handle&&this.getHyperCubeData()}},onChartResults:{value:function(a){console.log("Chart created"),console.log(a),this.hideLoading();var b=document.createElement("div");b.classList.add("chart-result");var c=document.getElementById(this.resultsElement);c.innerHTML="",c&&c.appendChild(b),"CapabilityAPI"==senseSearch.exchange.connectionType&&a.show(b)}},onNoResults:{writable:!0,value:function(){this.hideLoading(),this.renderItems([])}},onClear:{writable:!0,value:function(){this.hideLoading(),document.getElementById(this.id+"_results").innerHTML=""}},getNextBatch:{value:function(){this.pageTop+=this.pageSize,this.getHyperCubeData()}},getHyperCubeData:{value:function(a){var b=this;senseSearch.exchange.getLayout(this.handle,function(c){var d=c.result.qLayout;b.latestLayout=d,console.trace();var e=d.qHyperCube.qDimensionInfo.concat(d.qHyperCube.qMeasureInfo);senseSearch.exchange.ask(b.handle,"GetHyperCubeData",["/qHyperCubeDef",[{qTop:b.pageTop,qLeft:0,qHeight:b.pageSize,qWidth:b.fields.length}]],function(c){if(senseSearch.exchange.seqId==c.id)if(a&&"function"==typeof a)a.call(this,c);else{for(var d=c.result.qDataPages,f=[],g=0;g<d[0].qMatrix.length;g++){var h={};if(!b.nullSuppressor||null==b.nullSuppressor||"-"!=d[0].qMatrix[g][b.nullSuppressor].qText){for(var i=0;i<d[0].qMatrix[g].length;i++)h[e[i].qFallbackTitle]={value:d[0].qMatrix[g][i].qText,html:b.highlightText(d[0].qMatrix[g][i].qText)};f.push(h)}}var j=b.pageTop/b.pageSize;-1==b.pagesLoaded.indexOf(j)&&(b.pagesLoaded.push(j),b.data=b.data.concat(f)),b.renderItems(f)}})})}},getFieldIndex:{value:function(a){for(var b=0;b<this.fields.length;b++){if(this.fields[b].dimension&&this.fields[b].dimension==a)return{index:b,type:"dimension"};if(this.fields[b].label&&this.fields[b].label==a)return{index:b,type:"measure"}}return 0}},getInterColumnSortOrder:{value:function(a){for(var b=[a],c=0;c<this.fields.length;c++)c!=a&&b.push(c);return b}},highlightText:{value:function(a){if(senseSearch.terms&&this.enableHighlighting){for(var b=senseSearch.terms,c=0;c<b.length;c++)a=a.replace(new RegExp(b[c],"i"),"<span class='highlight"+c+"'>"+b[c]+"</span>");return a}return a}},renderItems:{writable:!0,value:function(a){if(this.data.length>0){var b=document.getElementById(this.id+"_ul");b||(b=document.createElement("ul"),b.id=this.id+"_ul",document.getElementById(this.id+"_results").appendChild(b));var c="",d=0;for(var e in a[0])d++;var f=Math.floor(100/d);c+="<li>";for(var g in a[0])c+="<div class='sense-search-result-cell' style='width: "+f+"%'>",c+="<strong>"+g+"</strong>",c+="</div>";c+="</li>";for(var h=0;h<a.length;h++){c+="<li>";for(var g in a[h])c+="<div class='sense-search-result-cell' style='width: "+f+"%'>",c+=a[h][g].html,c+="</div>";c+="</li>"}document.getElementById(this.id+"_ul").innerHTML=c}else c="<h1>No Results</h1>",document.getElementById(this.resultsElement).innerHTML=c}},applySort:{value:function(a,b,c){var d=this;this.currentSort=a,b=b||!1,c=c||!1,senseSearch.exchange.ask(this.handle,"ApplyPatches",[[{qPath:"/qHyperCubeDef/qInterColumnSortOrder",qOp:"replace",qValue:JSON.stringify(d.getInterColumnSortOrder(d.getFieldIndex(a).index))}],!0],function(){b&&(d.pageTop=0,d.pagesLoaded=[]),c&&1==c&&d.getHyperCubeData()})}},invertSort:{value:function(a,b,c){var d,e=this,f=this.getFieldIndex(a);d="dimension"==f.type?"/qHyperCubeDef/qDimensions/"+f.index+"/qDef/qReverseSort":"/qHyperCubeDef/qMeasures/"+f.index+"/qDef/qReverseSort";var e=this;b=b||!1,c=c||!1,senseSearch.exchange.ask(this.handle,"ApplyPatches",[[{qPath:"/qHyperCubeDef/qInterColumnSortOrder",qOp:"replace",qValue:JSON.stringify(e.getInterColumnSortOrder(f.index))},{qPath:d,qOp:"replace",qValue:"true"}],!0],function(){b&&(e.pageTop=0,e.pagesLoaded=[]),c&&1==c&&e.getHyperCubeData()})}}}),a}();Subscription.prototype=Object.create(Object.prototype,{subscribe:{value:function(a){this.callbackList.push(a)}},deliver:{value:function(a){for(var b=0;b<this.callbackList.length;b++)this.callbackList[b].call(null,a)}}});var SenseSearch=function(){function a(){var a,b,c=0,d=10;this.connect=function(e,f){b=f;try{a=new WebSocket(e)}catch(g){}a.onopen=function(){console.log("Socket connected! readyState = "+a.readyState),c=0,b.call(null,{method:"connected"})},a.onmessage=function(a){var c;c=a.data,b.call(null,JSON.parse(c))},a.onerror=function(a){b.call(null,null)},a.onclose=function(e){d>c?(c++,console.warn("Socket closed! --> Reconnect in 5 secs (retry "+c+")"),setTimeout(function(){3===a.readyState&&b.call(null,{method:"socketClosed",isConnecting:!1})},5e3)):(console.warn("Sorry, can't reconnect socket aftet "+d+" retries"),c=0)}},this.sendMessage=function(c,d){b=d;try{a.send(JSON.stringify(c))}catch(e){throw e}}}function b(a){console.log(a)}function c(){this.reboot()}var d=function(){function b(b,c){if(!b.app)return!1;b=b||{},b.host?b.port=b.port||"":b.port="4848",b.host=b.host||"localhost",b.prefix=b.prefix||"",b.isSecure=b.isSecure||"https:"==window.location.protocol,b.ticket=b.ticket||!1;var d="ws";d+=b.isSecure?"s://":"://",d+=b.host,d+=b.port?":"+b.port:"",d+=b.prefix,d+="/app/",d+=b.app,d+=b.ticket?"qlikTicket="+b.ticket:"",this.connection=new a,this.connection.connect(d,c)}return b.prototype=Object.create(Object.prototype,{connection:{writable:!0,value:null},ask:{value:function(a,b,c,d,e){var f={id:d,handle:a,method:b,params:c};this.connection.sendMessage(f,e)}}}),b}(),e=function(){function a(a,b,c){var e=this;this.connectionType=b,"Native"==b?this.connection=new d(a,function(){e.connection.ask(-1,"OpenDoc",[a.app],0,function(a){c.call(null,a)})}):"QSocks"==b?(this.connection=a,this.seqId=this.connection.seqid):"Enigma"==b?(this.connection=a.session,this.seqId=this.connection.rpc.requestId):"CapabilityAPI"==b&&(this.connection=a.global.session,this.app=a)}return a.prototype=Object.create(Object.prototype,{connectionType:{writable:!0,value:null},seqId:{writable:!0,value:0},pendingCallbacks:{writable:!0,value:{}},connection:{writable:!0,value:null},ask:{value:function(a,b,c,d){switch(this.connectionType){case"Native":this.askNative(a,b,c,d);break;case"QSocks":this.askQSocks(a,b,c,d);break;case"CapabilityAPI":this.askCapabilityAPI(a,b,c,d);break;case"Enigma":this.askEnigma(a,b,c,d)}"Native"==this.connectionType}},createCapabilityViz:{value:function(){}},askNative:{value:function(a,b,c,d){var e=this;this.seqId++,this.pendingCallbacks[this.seqId]=d,this.connection.ask(a,b,c,this.seqId,function(a){if(a.error);else{var b=e.pendingCallbacks[a.id];b&&(b.call(null,a),delete e.pendingCallbacks[a.id])}})}},askQSocks:{value:function(a,c,d,e){this.connection.seqid++,this.seqId=this.connection.seqid,this.connection.ask(a,c,d,this.connection.seqid).then(function(a){a.error||e.call(null,a)},b)}},askCapabilityAPI:{value:function(a,c,d,e){var f,g=this;f=this.connection.__enigmaSession&&this.connection.__enigmaSession.rpc?this.connection.__enigmaSession.rpc.send:this.connection.rpc,f({handle:a,method:c,params:d}).then(function(a){g.seqId=a.id,a.error||e.call(null,a)},b)}},askEnigma:{value:function(a,c,d,e){var f=this;this.connection.rpc.send({handle:a,method:c,params:d,outKey:-1,delta:!1}).then(function(a){f.seqId=a.id,a.error||e.call(null,a)},b)}},getLayout:{value:function(a,b){this.ask(a,"GetLayout",[],b)}}}),a}();return c.prototype=Object.create(Object.prototype,{init:{value:function(){for(var a=document.getElementsByTagName("sense-search-input"),b=0;b<a.length;){var c=a[b].id,d=new SenseSearchInput(c);this.inputs[c]=d.object}for(var e=document.getElementsByTagName("sense-search-results"),b=0;b<e.length;){var c=e[b].id,f=new SenseSearchResult(c);this.results[c]=f.object}}},reboot:{value:function(){this.ready=new Subscription,this.searchStarted=new Subscription,this.searchResults=new Subscription,this.searchAssociations=new Subscription,this.fieldsFetched=new Subscription,this.noResults=new Subscription,this.suggestResults=new Subscription,this.chartResults=new Subscription,this.onSelectionsApplied=new Subscription,this.onSelectionsError=new Subscription,this.onLockedUnlocked=new Subscription,this.cleared=new Subscription,this.inputs=[],this.results=[]}},appFields:{writable:!0,value:{}},appFieldsByTag:{writable:!0,value:{}},fieldsForSelecting:{value:[]},fieldHandles:{value:[]},inputs:{writable:!0,value:{}},results:{writable:!0,value:{}},pendingSearch:{writable:!0,value:null},pendingSuggest:{writable:!0,value:null},pendingChart:{writable:!0,value:null},appHandle:{writable:!0,value:null},exchange:{writable:!0,value:null},searchInput:{value:SenseSearchInput},connect:{value:function(a,b){var c=this;this.exchange=new e(a,"Native",function(a){a.result&&a.result.qReturn&&(c.appHandle=a.result.qReturn.qHandle,c.ready.subscribe(b),c.ready.deliver())})}},connectWithQSocks:{value:function(a){this.appHandle=a.handle,this.exchange=new e(a.connection,"QSocks"),this.ready.deliver()}},connectWithCapabilityAPI:{value:function(a){this.appHandle=a.global.session.connectedAppHandle||a.model.handle,this.exchange=new e(a,"CapabilityAPI"),this.ready.deliver()}},connectWithEnigma:{value:function(a){this.appHandle=a.session.apis.entries[1].api.handle,this.exchange=new e(a,"Enigma"),this.ready.deliver()}},readOptions:{value:function(a){for(var b in a)this[0]=a[b]}},ready:{writable:!0,value:null},newResultsDefinition:{value:function(a,b,c){var d=new Result(a);this.results.push(d)}},fieldsFetched:{writable:!0,value:null},search:{value:function(a,b,c,d){this.searchStarted.deliver();var e=this;c=c||"simple",d=d||this.context||"LockedFieldsOnly",this.pendingSearch=this.exchange.seqId+1,this.terms=a.split(" "),this.exchange.ask(this.appHandle,"SearchAssociations",[{qContext:d,qSearchFields:b},this.terms,{qOffset:0,qCount:5,qMaxNbrFieldMatches:5}],function(f){"visualizations"==c?e.searchAssociations.deliver(f.result):f.id==e.pendingSearch&&(""==a||f.result.qResults.qTotalSearchResults>0?"simple"==c?e.selectAssociations(b,0,d):e.searchAssociations.deliver(f.result):e.noResults.deliver())})}},selectAssociations:{value:function(a,b,c){c=c||this.context||"LockedFieldsOnly";var d=this;d.exchange.ask(d.appHandle,"SelectAssociations",[{qContext:c,qSearchFields:a},d.terms,b],function(a){d.searchResults.deliver(a.change)})}},searchAndSelect:{value:function(a,b,c,d){this.searchStarted.deliver();var e=this;d=d||this.context||"LockedFieldsOnly",this.pendingSearch=this.exchange.seqId+1,this.terms=a.split(" "),this.exchange.ask(this.appHandle,"SearchAssociations",[{qContext:d,qSearchFields:b},this.terms,{qOffset:0,qCount:5,qMaxNbrFieldMatches:5}],function(f){(f.id==e.pendingSearch||f.id==e.exchange.seqId)&&(""==a||f.result.qResults.qTotalSearchResults>0?e.selectAssociations(b,c,d):e.noResults.deliver())})}},suggest:{value:function(a,b,c){var d=this;d.pendingSuggest=this.exchange.seqId+1,this.exchange.ask(this.appHandle,"SearchSuggest",[{qContext:c||this.context||"LockedFieldsOnly",qSearchFields:b},a.split(" ")],function(a){a.id==d.pendingSuggest&&d.suggestResults.deliver(a.result.qResult)})}},selectTextInField:{value:function(a,b,c){c=null==c?!0:!1;for(var d=this,e=[],f=0;f<b.length;f++)e.push({qText:b[f]});if(-1===this.fieldsForSelecting.indexOf(a))this.exchange.ask(this.appHandle,"GetField",[a],function(b){if(null==b.result.qReturn.qHandle)this.onSelectionsError.deliver();else{var f=b.result.qReturn.qHandle;d.fieldHandles.push(f),d.fieldsForSelecting.push(a),d.exchange.ask(f,"SelectValues",[e,c],function(a){d.onSelectionsApplied.deliver()})}});else{var g=this.fieldHandles[this.fieldsForSelecting.indexOf(a)];this.exchange.ask(g,"SelectValues",[e,c],function(a){d.onSelectionsApplied.deliver()})}}},selectInField:{value:function(a,b,c){c=null==c?!0:!1;var d=this;if(-1===this.fieldsForSelecting.indexOf(a))this.exchange.ask(this.appHandle,"GetField",[a],function(e){if(null==e.result.qReturn.qHandle)this.onSelectionsError.deliver();else{var f=e.result.qReturn.qHandle;d.fieldHandles.push(f),d.fieldsForSelecting.push(a),d.exchange.ask(f,"LowLevelSelect",[b,c],function(a){d.onSelectionsApplied.deliver()})}});else{var e=this.fieldHandles[this.fieldsForSelecting.indexOf(a)];this.exchange.ask(e,"LowLevelSelect",[b,c],function(a){d.onSelectionsApplied.deliver()})}}},createViz:{value:function(a){this.searchStarted.deliver();var c=this;if(c.pendingChart=this.exchange.seqId+1,"CapabilityAPI"==this.exchange.connectionType){var d=[],e=a;e.wsId=c.pendingChart;var f="/qHyperCubeDef",g=e.qHyperCubeDef;"kpi"==a.qInfo.qType&&(e.color={useBaseColors:"measure"},e.qHyperCubeDef.qMeasures[0].qDef.measureAxis={min:0,max:100},e.qHyperCubeDef.qMeasures[0].qDef.conditionalColoring={useConditionalColoring:!1,singleColor:3,paletteSingleColor:{index:6},segments:{limits:[],paletteColors:[{index:6}]}},e.fontSize="S"),"boxplot"==a.qInfo.qType&&(f="/boxplotDef/qHyperCubeDef",e.boxplotDef={qHyperCubeDef:e.qHyperCubeDef},e.boxplotDef.qHyperCubeDef.calculations={auto:!0,mode:"tukey",parameters:{tukey:1.5,fractiles:.01,stdDev:3}},e.boxplotDef.qHyperCubeDef.elements={firstWhisker:{name:"",expression:null},boxStart:{name:"",expression:null},boxMiddle:{name:"",expression:null},boxEnd:{name:"",expression:null},lastWhisker:{name:"",expression:null},outliers:{include:!0}},e.boxplotDef.qHyperCubeDef.presentation={whiskers:{show:!0}},e.boxplotDef.qHyperCubeDef.color={box:{paletteColor:{index:-1,color:"#E6E6E6"}},point:{paletteColor:{index:6,color:"#4477aa"}}},delete e.qHyperCubeDef,g=e.boxplotDef.qHyperCubeDef),this.exchange.app.visualization.create(a.qInfo.qType,d,e).then(function(a){c.exchange.ask(a.model.handle,"ApplyPatches",[[{qPath:f,qOp:"replace",qValue:JSON.stringify(g)}],!0],function(b){a.model.getLayout().then(function(){c.chartResults.deliver(a)})})},b)}else this.exchange.ask(this.appHandle,"CreateSessionObject",[a],function(a){a.id==c.pendingChart&&c.exchange.ask(a.result.qReturn.qHandle,"GetLayout",[],function(b){c.chartResults.deliver({model:a.result.qReturn,layout:b})})})}},clear:{value:function(a){var b=this;a===!0?this.exchange.ask(this.appHandle,"UnlockAll",[],function(a){b.exchange.ask(b.appHandle,"ClearAll",[],function(a){b.terms=null,b.cleared.deliver()})}):this.exchange.ask(this.appHandle,"ClearAll",[],function(a){b.terms=null,b.cleared.deliver()})}},getAppFields:{value:function(a){var b=this,c=2,d={fields:null,dimensions:null,measures:null,setCount:0};b.exchange.ask(b.appHandle,"CreateSessionObject",[{qInfo:{qType:"FieldList"},qFieldListDef:{qShowSystem:!1}}],function(e){var f=e.result.qReturn.qHandle;b.exchange.ask(f,"GetLayout",[],function(e){d.fields=e.result.qLayout.qFieldList.qItems,d.setCount++,d.setCount===c&&b.sortFieldsByTag(d,a)})}),b.exchange.ask(b.appHandle,"CreateSessionObject",[{qInfo:{qType:"DimensionList"},qDimensionListDef:{qType:"dimension",qData:{title:"/qMetaDef/title",tags:"/qMetaDef/tags",grouping:"/qDim/qGrouping",info:"/qDimInfos"}}}],function(e){var f=e.result.qReturn.qHandle;b.exchange.ask(f,"GetLayout",[],function(e){d.dimensions=e.result.qLayout.qDimensionList.qItems,d.setCount++,d.setCount===c&&b.sortFieldsByTag(d,a)})}),d.measures=[]}},sortFieldsByTag:{value:function(a,b){for(var c=0;c<a.fields.length;c++){var d=a.fields[c].qName.toLowerCase().replace(/ /gi,"_");this.appFields[d]=a.fields[c];for(var e=0;e<a.fields[c].qTags.length;e++)this.appFieldsByTag[a.fields[c].qTags[e]]||(this.appFieldsByTag[a.fields[c].qTags[e]]={}),this.appFieldsByTag[a.fields[c].qTags[e]][d]={fieldName:a.fields[c].qName},a.fields[c].qCardinal>b&&(this.appFieldsByTag.$possibleMeasure||(this.appFieldsByTag.$possibleMeasure={}),this.appFieldsByTag.$possibleMeasure[d]={fieldName:a.fields[c].qName})}for(var c=0;c<a.dimensions.length;c++){var d=a.dimensions[c].qData.title.toLowerCase().replace(/ /gi,"_");this.appFields[d]=a.dimensions[c],this.appFieldsByTag.$dimension||(this.appFieldsByTag.$dimension={}),this.appFieldsByTag.$dimension[d]={fieldName:a.dimensions[c].qData.title},a.fields[c].qCardinal>b&&(this.appFieldsByTag.$possibleMeasure||(this.appFieldsByTag.$possibleMeasure={}),this.appFieldsByTag.$possibleMeasure[d]={fieldName:a.fields[c].qName});for(var e=0;e<a.dimensions[c].qMeta.tags.length;e++){var f=a.dimensions[c].qMeta.tags[e];-1==f.indexOf("$")&&(f="$"+f),this.appFieldsByTag[f]||(this.appFieldsByTag[f]={}),this.appFieldsByTag[f][d]={fieldName:a.dimensions[c].qData.title}}}for(var c=0;c<a.measures.length;c++){var d=a.measures[c].qData.title.toLowerCase().replace(/ /gi,"_");this.appFields[d]=a.measures[c],this.appFieldsByTag.$measure||(this.appFieldsByTag.$measure={}),this.appFieldsByTag.$measure[d]={fieldName:a.measures[c].qData.title};for(var e=0;e<a.measures[c].qMeta.tags.length;e++){var f=a.measures[c].qMeta.tags[e];-1==f.indexOf("$")&&(f="$"+f),this.appFieldsByTag[f]||(this.appFieldsByTag[f]={}),this.appFieldsByTag[f][d]={fieldName:a.measures[c].qData.title}}}this.fieldsFetched.deliver()}},searchStarted:{writable:!0,value:null},searchResults:{writable:!0,value:null},searchAssociations:{writable:!0,value:null},selectionsApplied:{writable:!0,value:null},onSelectionsError:{writable:!0,value:null},lockedUnlocked:{writable:!0,value:null},noResults:{writable:!0,value:null},chartResults:{writable:!0,value:null},suggestResults:{writable:!0,value:null}}),c}();if("undefined"!=typeof document){var senseSearch=new SenseSearch;senseSearch.init()}else module.exports=new SenseSearch;